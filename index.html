<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Crypto-données avec Options</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-color: #0d1b2a; /* bleu sombre */
      color: #ffffff;
    }
    .container {
      display: flex;
      justify-content: space-between;
      max-width: 900px;
      margin: auto;
      flex-wrap: wrap;
    }
    .chart-box, .options-box {
      width: 45%;
      text-align: center;
      margin-top: 20px;
    }
    .chart-title {
      font-weight: bold;
      margin-bottom: 8px;
      font-size: 18px;
      color: #ffffff;
    }
    iframe {
      border: none;
      width: 100%;
      height: 300px;
    }
    h1 {
      text-align: center;
      color: #ffffff;
    }
  </style>
</head>
<body>
  <h1>Crypto-données</h1>
  <div class="container">
    <div class="chart-box">
      <div class="chart-title">BTCUSD</div>
      <iframe src="https://s.tradingview.com/widgetembed/?symbol=BINANCE:BTCUSDT&interval=60&theme=dark&style=1&locale=fr"
        scrolling="no"></iframe>
    </div>
    <div class="chart-box">
      <div class="chart-title">ETHUSD</div>
      <iframe src="https://s.tradingview.com/widgetembed/?symbol=BINANCE:ETHUSDT&interval=60&theme=dark&style=1&locale=fr"
        scrolling="no"></iframe>
    </div>
  </div>

  <div class="container">
    <div class="options-box">
      <div class="chart-title">Options BTC (ATM, ITM, OTM %)</div>
      <canvas id="btcChart"></canvas>
    </div>
    <div class="options-box">
      <div class="chart-title">Options ETH (ATM, ITM, OTM %)</div>
      <canvas id="ethChart"></canvas>
    </div>
  </div>

  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    // Traduction de ton Python en JS

    async function getSpotPrice(asset) {
      const instrument = `${asset}-PERPETUAL`;
      const url = `https://www.deribit.com/api/v2/public/ticker?instrument_name=${instrument}`;
      const response = await fetch(url);
      const data = await response.json();
      if (!data.result) throw new Error(`Impossible de récupérer le prix spot pour ${asset}.`);
      return data.result.last_price;
    }

    async function getOptions(asset) {
      const url = `https://www.deribit.com/api/v2/public/get_instruments?currency=${asset}&kind=option&expired=false`;
      const response = await fetch(url);
      const data = await response.json();
      return data.result || [];
    }

    function categorizeOptions(options, spotPrice, atmThreshold = 0.01) {
      let countATM = 0, countITM = 0, countOTM = 0;
      for (const opt of options) {
        const strike = opt.strike;
        const optionType = opt.option_type;
        if (Math.abs(strike - spotPrice) / spotPrice <= atmThreshold) {
          countATM++;
        } else {
          if (optionType === 'call') {
            if (strike < spotPrice) countITM++;
            else countOTM++;
          } else if (optionType === 'put') {
            if (strike > spotPrice) countITM++;
            else countOTM++;
          }
        }
      }
      const total = options.length;
      if (total === 0) return [0, 0, 0];
      return [
        (countATM / total) * 100,
        (countITM / total) * 100,
        (countOTM / total) * 100
      ];
    }

    async function fetchAndRenderChart(asset, canvasId) {
      try {
        const spotPrice = await getSpotPrice(asset);
        const options = await getOptions(asset);
        const [atm, itm, otm] = categorizeOptions(options, spotPrice);
        
        const ctx = document.getElementById(canvasId).getContext('2d');
        new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: ['ATM', 'ITM', 'OTM'],
            datasets: [{
              label: `Répartition options ${asset}`,
              data: [atm.toFixed(2), itm.toFixed(2), otm.toFixed(2)],
              backgroundColor: ['#f39c12', '#27ae60', '#c0392b'],
              hoverOffset: 30
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: { labels: { color: 'white' } },
              title: {
                display: true,
                text: `Répartition options ${asset} par catégorie (%)`,
                color: 'white',
                font: { size: 16 }
              }
            }
          }
        });
      } catch (err) {
        console.error(err);
        document.getElementById(canvasId).parentNode.innerHTML = `<p>Erreur lors du chargement des données pour ${asset}.</p>`;
      }
    }

    // Lancer le rendu des deux graphiques
    fetchAndRenderChart('BTC', 'btcChart');
    fetchAndRenderChart('ETH', 'ethChart');
  </script>
</body>
</html>


